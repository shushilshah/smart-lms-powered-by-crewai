{% extends "dashboards/base.html" %}
{% block title %}{{ course.title }}{% endblock %}


{% load youtube_filters %}
{% block content %}
<div class="row">

  <!-- ================= LEFT SIDEBAR ================= -->
  <div class="col-md-3 border-end" style="height: 90vh; overflow-y: auto;">
    <h5 class="fw-bold mt-3">Modules</h5>

    <div class="accordion" id="modulesAccordion">
      {% for module in modules %}
        <div class="accordion-item">

          <!-- Module Header -->
          <h2 class="accordion-header" id="heading{{ module.id }}">
            <button class="accordion-button collapsed" type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapse{{ module.id }}"
                    aria-expanded="false"
                    aria-controls="collapse{{ module.id }}">
              {{ module.title }}
            </button>
          </h2>

          <!-- Module Lessons -->
          <div id="collapse{{ module.id }}"
               class="accordion-collapse collapse"
               aria-labelledby="heading{{ module.id }}"
               data-bs-parent="#modulesAccordion">

            <div class="accordion-body p-0">
              <ul class="list-group list-group-flush">

                {% for lesson_item in module.lessons.all %}
                  {% if lesson_item.is_published %}
                    <li class="list-group-item d-flex justify-content-between align-items-center
                    {% if lesson and lesson.id == lesson_item.id %}
                        bg-light fw-bold
                    {% endif %}">

                      <a class="text-decoration-none"
                         href="{% url 'lesson_detail_student' course.id %}?lesson={{ lesson_item.id }}">
                        ▶ {{ lesson_item.title }}
                      </a>

                      {% if lesson_item.id in completed_lessons %}
                        <span class="badge bg-success">✓</span>
                      {% endif %}

                    </li>
                  {% endif %}
                {% empty %}
                  <li class="list-group-item text-muted small">
                    No lessons available
                  </li>
                {% endfor %}

              </ul>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>

  <!-- ================= MAIN CONTENT ================= -->
  <div class="col-md-9 p-4">

    {% if lesson %}
      <h3 class="fw-bold">{{ lesson.title }}</h3>
      <p class="text-muted mb-3">Module: {{ lesson.module.title }}</p>

      <!-- TEXT LESSON -->
      {% if lesson.lesson_type == "text" %}
        <div class="card shadow-sm p-4">
          {{ lesson.content|safe }}
        </div>

      <!-- VIDEO LESSON -->
      {% elif lesson.lesson_type == "video" %}
        <div class="ratio ratio-16x9 mb-3">
          <iframe src="{{ lesson.video| youtube_embed }}" allowfullscreen></iframe>
        </div>

      <!-- PDF / EXTERNAL -->
      {% elif lesson.lesson_type == "pdf" %}
        <iframe src="{{ lesson.external_link.url }}"
                width="100%" height="600"></iframe>

      {% elif lesson.lesson_type == "external" %}
        <a href="{{ lesson.external_link }}"
           target="_blank"
           class="btn btn-primary">
          Open Resource
        </a>
      {% endif %}

      <!-- MARK COMPLETED -->
      {% if lesson.id not in completed_lessons %}
        <form method="post" class="mt-4">
          {% csrf_token %}
          <button class="btn btn-success">
            ✔ Mark as Completed
          </button>
        </form>
      {% else %}
        <div class="alert alert-success mt-4">
          Lesson Completed ✔
        </div>
      {% endif %}

    {% else %}
      <p class="text-muted">No lesson selected.</p>
    {% endif %}

  </div>
</div>
{% endblock %}
